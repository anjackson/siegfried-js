<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/pyodide/v0.20.0/full/pyodide.js"></script>
</head>
<body>
  
  <h1>
    Fido JS
  </h1>
  <p>
    This web page will run the Fido format identification tool on any file you give to it.  It runs entirely in your browser. It uses Pyodide to make this possible.
  </p>
<input type="file" onchange="doit();" id="file"/>
<div>Output:</div>
<textarea id="output" style="width: 100%;" rows="6" disabled></textarea>
  
      <script type="text/javascript">
    </script>

<script type="text/javascript">
var content = null;

      async function main() {
        let pyodide = await loadPyodide();
  await pyodide.loadPackage("micropip");
  await pyodide.runPythonAsync(`
  import micropip
  await micropip.install("https://cdn.glitch.global/f8da79db-ea7c-4974-a19e-5d782bb065e6/olefile-0.46-py2.py3-none-any.whl")
  await micropip.install("https://cdn.glitch.global/f8da79db-ea7c-4974-a19e-5d782bb065e6/opf_fido-1.4.1-py3-none-any.whl")
`);
        return pyodide;
      }
      let pyodideReadyPromise = main();

async function doit() {
        let pyodide = await pyodideReadyPromise;  

  const outputLog = document.getElementById("output");
  outputLog.value = "";
    var file = document.getElementById("file").files[0];
    var reader = new FileReader();
    reader.readAsBinaryString(file);
    reader.onload = evt => { 
        content = evt.target.result;
        filename = file.name;
        try {
        var output = pyodide.runPython(
`from js import filename, content

with open(filename, "wb") as f:
          f.write(content.encode())
        
from fido import fido
import sys
import io

sys.stdout = io.StringIO()

sys.argv = ['fido', filename]

fido.main()
        `);
          const stdout = pyodide.runPython("sys.stdout.getvalue()");

        outputLog.value += stdout;
        } catch (err) {
          outputLog.value += err;
        }
      /*
      For downloading the output
        var l = output.length;
        var array = new Uint8Array(l);
        for (var i = 0; i < l; i++) {
            array[i] = output.charCodeAt(i);
        }
        var blob = new Blob([array], {type: 'application/octet-stream'});
        var elem = window.document.createElement('a');
        elem.href = window.URL.createObjectURL(blob);
        elem.download = 'output.pdf';
        document.body.appendChild(elem);
        //elem.click();        
        //document.body.removeChild(elem);
        */
    }
}

</script>
</body>